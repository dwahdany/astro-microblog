<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>Content Manager</title>
</head>
<body>
  <script type="module" src="https://unpkg.com/@sveltia/cms/dist/sveltia-cms.js"></script>
  <script>
    // Auto-fill blogmark title and slug from URL
    let lastFetchedUrl = '';

    function getFieldInput(keyPath) {
      const section = document.querySelector(`section[data-key-path="${keyPath}"]`);
      return section?.querySelector('input');
    }

    function fillField(keyPath, value) {
      const input = getFieldInput(keyPath);
      if (input && !input.value.trim()) {
        const nativeSetter = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value').set;
        nativeSetter.call(input, value);
        input.dispatchEvent(new Event('input', { bubbles: true }));
      }
    }

    async function fetchAndFillMeta(url) {
      if (!url || url === lastFetchedUrl) return;
      if (!url.startsWith('http://') && !url.startsWith('https://')) return;

      lastFetchedUrl = url;

      try {
        const response = await fetch(`/api/fetch-meta?url=${encodeURIComponent(url)}`);
        const data = await response.json();

        // Use setTimeout to escape current Svelte update cycle
        setTimeout(() => {
          if (data.slug) fillField('slug', data.slug);
          setTimeout(() => {
            if (data.title) fillField('link_title', data.title);
          }, 0);
        }, 0);
      } catch (e) {
        console.error('Failed to fetch metadata:', e);
      }
    }

    // Watch for URL input changes
    document.addEventListener('input', (e) => {
      const section = e.target.closest('section[data-key-path]');
      if (section?.dataset.keyPath === 'link_url') {
        clearTimeout(window.metaFetchTimeout);
        window.metaFetchTimeout = setTimeout(() => {
          fetchAndFillMeta(e.target.value);
        }, 500);
      }
    });
  </script>
</body>
</html>
